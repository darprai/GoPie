<!DOCTYPE html>
<html lang="it">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
Â  Â  <title>Go Pie Go</title>
Â  Â Â 
Â  Â  <link rel="icon" type="image/x-icon" href="assets/sprites/favicon.ico">Â 

Â  Â  <link rel="manifest" href="manifest.json">
Â  Â  <meta name="theme-color" content="#000000">Â 
Â  Â  <link rel="apple-touch-icon" href="assets/sprites/icon-512.png">
Â  Â  <style>
Â  Â  Â  Â  /* MODIFICHE NECESSARIE PER SCHERMO INTERO MOBILE E NESSUNO SCORRIMENTO */
Â  Â  Â  Â  html, body {
Â  Â  Â  Â  Â  Â  height: 100%;Â 
Â  Â  Â  Â  Â  Â  overflow: hidden;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* BASE STYLES */
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  /* ğŸ› ï¸ SFONDO: COLORE FISSO BLU SCURO */
Â  Â  Â  Â  Â  Â  background-color: #000033;Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /* L'immagine di sfondo Ã¨ mantenuta, ma ORA NON HA EFFETTI DI SFOCATURA */
Â  Â  Â  Â  Â  Â  background-image: url('assets/sprites/icon-512.png');Â 
Â  Â  Â  Â  Â  Â  background-size: cover;
Â  Â  Â  Â  Â  Â  background-position: center;
Â  Â  Â  Â  Â  Â  background-repeat: no-repeat;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  height: 100vh;Â 
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  font-family: Arial, sans-serif;
Â  Â  Â  Â  Â  Â  overflow: hidden;Â 
Â  Â  Â  Â  Â  Â  touch-action: manipulation;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  #game-container {
Â  Â  Â  Â  Â  Â  filter: none;
Â  Â  Â  Â  Â  Â  -webkit-filter: none;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  display: block;Â 
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /* LOGICA DI SCALABILITÃ€ ADATTIVA */
Â  Â  Â  Â  Â  Â  max-width: 90vw;
Â  Â  Â  Â  Â  Â  max-height: 90vh;
Â  Â  Â  Â  Â  Â  aspect-ratio: 16 / 9;
Â  Â  Â  Â  Â  Â  width: min(90vw, (90vh * 16 / 9));
Â  Â  Â  Â  Â  Â  height: min(90vh, (90vw * 9 / 16));

Â  Â  Â  Â  Â  Â  background-color: transparent;
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
Â  Â  Â  Â  }

Â  Â  Â  Â  #game {
Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* MENU & ENDING STYLES */
Â  Â  Â  Â  #menu, #ending-screen {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  background-color: rgba(0, 0, 0, 0.9); /* Sfondo scuro per il contrasto */
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  z-index: 100;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  #menu h1, #ending-screen h1 {
Â  Â  Â  Â  Â  Â  color: #ff3333;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  #menu p, #ending-screen p {
Â  Â  Â  Â  Â  Â  color: #ffff00;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  #win-image {
Â  Â  Â  Â  Â  Â  max-width: 80%;
Â  Â  Â  Â  Â  Â  max-height: 50%;
Â  Â  Â  Â  Â  Â  margin: 20px 0;
Â  Â  Â  Â  Â  Â  display: none;Â 
Â  Â  Â  Â  Â  Â  object-fit: contain;
Â  Â  Â  Â  }

Â  Â  Â  Â  .menu-button, #restartBtn {
Â  Â  Â  Â  Â  Â  padding: 15px 30px;
Â  Â  Â  Â  Â  Â  font-size: 24px;
Â  Â  Â  Â  Â  Â  margin-top: 20px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  background-color: #00ffcc;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  color: black;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  transition: background-color 0.2s;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* CONTROLLI MOBILE */
Â  Â  Â  Â  #touch-move {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  bottom: 0;
Â  Â  Â  Â  Â  Â  right: 0;Â 
Â  Â  Â  Â  Â  Â  height: 100%;Â 
Â  Â  Â  Â  Â  Â  width: calc(100% - 120px);Â 
Â  Â  Â  Â  Â  Â  z-index: 101;Â 
Â  Â  Â  Â  Â  Â  display: none;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  #jumpBtn {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  bottom: 20px;
Â  Â  Â  Â  Â  Â  left: 20px;Â 
Â  Â  Â  Â  Â  Â  width: 80px;
Â  Â  Â  Â  Â  Â  height: 80px;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  background-color: #ff3333;Â 
Â  Â  Â  Â  Â  Â  font-size: 0;Â 
Â  Â  Â  Â  Â  Â  color: transparent;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  border: 3px solid #cc0000;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 10px rgba(255, 51, 51, 0.8);
Â  Â  Â  Â  Â  Â  user-select: none;
Â  Â  Â  Â  Â  Â  z-index: 102;Â 
Â  Â  Â  Â  Â  Â  display: none;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  #jumpBtn:active {
Â  Â  Â  Â  Â  Â  background-color: #cc0000;
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 5px rgba(255, 51, 51, 0.8) inset;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  @media screen and (max-width: 960px) {
Â  Â  Â  Â  Â  Â  #touch-move, #jumpBtn {
Â  Â  Â  Â  Â  Â  Â  Â  /* I controlli touch sono nascosti per default e mostrati dalla funzione JS */
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>

<audio id="music_normal" src="assets/music/music_normal.mp3" loop></audio>
<audio id="music_final" src="assets/music/music_final.mp3" loop></audio>

<div id="game-container">
Â  Â  <canvas id="game" width="960" height="540"></canvas>

Â  Â  <div id="touch-move"></div>Â 
Â  Â  <button id="jumpBtn"></button>

Â  Â  <div id="menu">
Â  Â  Â  Â  <h1>Go Pie Go</h1>
Â  Â  Â  Â  <p>Vesti i panni di Pie, prendi i cuori delle Hoes e diventa King!</p>
Â  Â  Â  Â  <button id="newBtn" class="menu-button">Inizia Partita</button>Â 
Â  Â  Â  Â  <p id="loading-message" style="display:none;"></p>
Â  Â  Â  Â  <p id="hint-text" style="display:none;">Usa â¬…ï¸ â¡ï¸ per muoverti e â¬†ï¸ / Spazio per saltare.</p>
Â  Â  </div>

Â  Â  <div id="ending-screen" style="display:none;">
Â  Â  Â  Â  <h1 id="ending-title"></h1>
Â  Â  Â  Â  <img id="win-image" src="assets/sprites/win.png" alt="Pie King">
Â  Â  Â  Â  <p id="ending-score"></p>
Â  Â  Â  Â  <button id="restartBtn" class="menu-button">Ricomincia</button>
Â  Â  </div>
</div>

<script>
Â  Â  // **************************************************
Â  Â  // Caricamento Sprite
Â  Â  // **************************************************
Â  Â  window.playerSprite = new Image(); window.playerSprite.src = 'assets/sprites/pie.png';Â 
Â  Â  window.runSprite = new Image(); window.runSprite.src = 'assets/sprites/run.png';
Â  Â  window.heartSprite = new Image(); window.heartSprite.src = 'assets/sprites/heart.png';
Â  Â  window.drinkEnemySprite = new Image(); window.drinkEnemySprite.src = 'assets/sprites/drink.png';
Â  Â  window.discoBallSprite = new Image(); window.discoBallSprite.src = 'assets/sprites/disco.png';
Â  Â  window.djDiscSprite = new Image(); window.djDiscSprite.src = 'assets/sprites/djdisc.png';
Â  Â  window.paloSprite = new Image(); window.paloSprite.src = 'assets/sprites/palo.png';
Â  Â Â 
Â  Â  window.ragazzaSprite = new Image(); window.ragazzaSprite.src = 'assets/sprites/ragazza.png';Â 
Â  Â  window.macchinaSprite = new Image(); window.macchinaSprite.src = 'assets/sprites/macchina.png';
Â  Â Â 
Â  Â  window.bossSprite = new Image(); window.bossSprite.src = 'assets/sprites/golruk.png';
Â  Â  window.backgroundSprite = new Image(); window.backgroundSprite.src = 'assets/sprites/icon-512.png';Â 
Â  Â  window.winSprite = new Image(); window.winSprite.src = 'assets/sprites/win.png';
</script>

<script src="rects.js"></script>
<script src="player.js"></script>
<script src="projectile.js"></script>
<script src="boss_final.js"></script>
<script src="game.js"></script>Â 
<script src="engine.js"></script>Â 


<script>
Â  Â  /* -------------------------------------------
Â  Â  Â * GESTIONE DOM, SCREEN MODE, E INPUT TOUCH
Â  Â  Â * ------------------------------------------- */

Â  Â  function enterFullscreen(element) {
Â  Â  Â  Â  if (element.requestFullscreen) {
Â  Â  Â  Â  Â  Â  element.requestFullscreen();
Â  Â  Â  Â  } else if (element.webkitRequestFullscreen) {Â 
Â  Â  Â  Â  Â  Â  element.webkitRequestFullscreen();
Â  Â  Â  Â  } else if (element.msRequestFullscreen) {Â 
Â  Â  Â  Â  Â  Â  element.msRequestFullscreen();
Â  Â  Â  Â  }
Â  Â  }

Â  Â  document.addEventListener('DOMContentLoaded', function() {
Â  Â  Â  Â  const gameContainer = document.getElementById('game-container');
Â  Â  Â  Â  const newBtn = document.getElementById('newBtn');
Â  Â  Â  Â  const restartBtn = document.getElementById('restartBtn');
Â  Â  Â  Â  const jumpBtn = document.getElementById('jumpBtn');
Â  Â  Â  Â  const touchMove = document.getElementById('touch-move');Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById('ending-screen').style.display = 'none';Â 

Â  Â  Â  Â  // FUNZIONE: Avvia il gioco (livello 0) e gestisce il Fullscreen
Â  Â  Â  Â  const startGame = (e) => {
Â  Â  Â  Â  Â  Â  if (e) e.preventDefault();
Â  Â  Â  Â  Â  Â Â 
            // Nascondi il menu subito per evitare ulteriori interazioni
            document.getElementById('menu').style.display = 'none'; 

Â  Â  Â  Â  Â  Â  // 1. TENTA DI AVVIARE L'AUDIO (Cruciale che avvenga nel gesto utente)
Â  Â  Â  Â  Â  Â  const musicNormal = document.getElementById('music_normal');
Â  Â  Â  Â  Â  Â  if (musicNormal) {
Â  Â  Â  Â  Â  Â  Â  Â  musicNormal.currentTime = 0;
                // Usa .then per essere certi che il gioco parta anche se l'audio fallisce
Â  Â  Â  Â  Â  Â  Â  Â  musicNormal.play().then(() => {
                    console.log("Audio avviato con successo.");
                    // Chiamata a startNew() solo dopo che l'audio ha tentato l'avvio
                    finalizeStart(); 
                }).catch(error => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn("Riproduzione audio bloccata dal browser o errore:", error);
                    // Se l'audio fallisce, procedi comunque per non bloccare il gioco
                    finalizeStart(); 
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  } else {
                // Nessun audio, avvia direttamente
                finalizeStart();
            }

            function finalizeStart() {
                // 2. TENTA FULLSCREEN (Deve essere chiamato dal gesto utente per funzionare)
Â  Â  Â  Â  Â  Â  Â  Â  if (document.fullscreenElement === null && window.innerWidth < 960) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  enterFullscreen(gameContainer);Â 
Â  Â  Â  Â  Â  Â  Â  Â  }
                
                // 3. AVVIA LA LOGICA DI GIOCO
Â  Â  Â  Â  Â  Â  Â  Â  if (window.Game && window.Game.startNew) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.Game.startNew();Â 
                    // 4. MOSTRA I CONTROLLI TOUCH DOPO L'AVVIO DEL GIOCO
                    if(window.innerWidth < 960) {
                         document.getElementById('touch-move').style.display = 'block';
                         document.getElementById('jumpBtn').style.display = 'block';
                    }
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Game object non pronto o startNew non definito.');
Â  Â  Â  Â  Â  Â  Â  Â  }
            }
Â  Â  Â  Â  };

Â  Â  Â  Â  // Pulsante di AVVIO (Menu Iniziale)
Â  Â  Â  Â  newBtn.addEventListener('click', startGame);
Â  Â  Â  Â  newBtn.addEventListener('touchstart', startGame);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Pulsante di RIAVVIO (Schermata Finale)
Â  Â  Â  Â  const handleRestart = (e) => {
Â  Â  Â  Â  Â  Â  if (e) e.preventDefault();
Â  Â  Â  Â  Â  Â  document.getElementById('ending-screen').style.display = 'none';
Â  Â  Â  Â  Â  Â  // Ri-mostra il menu per ricominciare
Â  Â  Â  Â  Â  Â  document.getElementById('menu').style.display = 'flex';
Â  Â  Â  Â  };
Â  Â  Â  Â  restartBtn.addEventListener('click', handleRestart);
Â  Â  Â  Â  restartBtn.addEventListener('touchstart', handleRestart);

Â  Â  Â  Â  // INIZIALIZZAZIONEÂ 
Â  Â  Â  Â  if (window.Game && window.Game.init) {
Â  Â  Â  Â  Â  Â  window.Game.init();
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- GESTIONE INPUT TOUCH per Movimento (TouchMove) ---
Â  Â  Â  Â Â 
Â  Â  Â  Â  const handleMovementTouch = (e) => {
Â  Â  Â  Â  Â  Â  e.preventDefault();Â 
Â  Â  Â  Â  Â  Â  if (!window.Game || !window.Game.handleTouchInput) return;

Â  Â  Â  Â  Â  Â  const isEnd = (e.type === 'touchend' || e.type === 'touchcancel');
Â  Â  Â  Â  Â  Â  if (isEnd) {
Â  Â  Â  Â  Â  Â  Â  Â  window.Game.handleTouchInput('left', false);
Â  Â  Â  Â  Â  Â  Â  Â  window.Game.handleTouchInput('right', false);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const touch = e.touches[0];
Â  Â  Â  Â  Â  Â  if (!touch) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const area = touchMove.getBoundingClientRect();
Â  Â  Â  Â  Â  Â  const relativeX = touch.clientX - area.left;

Â  Â  Â  Â  Â  Â  if (relativeX < area.width / 2) {
Â  Â  Â  Â  Â  Â  Â  Â  // Sinistra
Â  Â  Â  Â  Â  Â  Â  Â  window.Game.handleTouchInput('left', true);
Â  Â  Â  Â  Â  Â  Â  Â  window.Game.handleTouchInput('right', false);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // Destra
Â  Â  Â  Â  Â  Â  Â  Â  window.Game.handleTouchInput('right', true);
Â  Â  Â  Â  Â  Â  Â  Â  window.Game.handleTouchInput('left', false);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  touchMove.addEventListener('touchstart', (e) => {
            // Impedisce lo scorrimento del browser
            if (e.touches.length > 0) handleMovementTouch(e);
        }, { passive: false });
        
Â  Â  Â  Â  touchMove.addEventListener('touchmove', (e) => {
            // Gestisce il movimento mentre si tiene premuto
            if (e.touches.length > 0) handleMovementTouch(e);
        }, { passive: false });
        
Â  Â  Â  Â  touchMove.addEventListener('touchend', handleMovementTouch);
Â  Â  Â  Â  touchMove.addEventListener('touchcancel', handleMovementTouch);Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- GESTIONE INPUT TOUCH per Salto (jumpBtn) ---
Â  Â  Â  Â  jumpBtn.addEventListener('touchstart', (e) => {
Â  Â  Â  Â  Â  Â  e.preventDefault();Â 
Â  Â  Â  Â  Â  Â  if (window.Game && window.Game.handleTouchInput) {
Â  Â  Â  Â  Â  Â  Â  Â  window.Game.handleTouchInput('jump', true);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }, { passive: false });

Â  Â  Â  Â  jumpBtn.addEventListener('touchend', (e) => {
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  if (window.Game && window.Game.handleTouchInput) {
Â  Â  Â  Â  Â  Â  Â  Â  window.Game.handleTouchInput('jump', false);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  });
</script>

<script>
Â  Â  if ('serviceWorker' in navigator) {
Â  Â  Â  Â  window.addEventListener('load', () => {
Â  Â  Â  Â  Â  Â  navigator.serviceWorker.register('service-worker.js')
Â  Â  Â  Â  Â  Â  Â  Â  .then(reg => console.log('Service Worker registrato!'))
Â  Â  Â  Â  Â  Â  Â  Â  .catch(err => console.error('Errore Service Worker:', err));
Â  Â  Â  Â  });
Â  Â  }
</script>
</body>
</html>
